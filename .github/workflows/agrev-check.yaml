# Reusable workflow: run agrev check on PRs.
# Usage in your repo's .github/workflows/review.yml:
#
#   name: Agent Review
#   on:
#     pull_request:
#       branches: [main]
#   jobs:
#     agrev:
#       uses: aezell/agrev/.github/workflows/agrev-check.yaml@main
#       with:
#         format: markdown
#
name: agrev check

on:
  workflow_call:
    inputs:
      format:
        description: "Output format: text, json, markdown, html"
        type: string
        default: "markdown"
      commit-range:
        description: "Commit range to check (default: PR diff)"
        type: string
        default: ""
      skip:
        description: "Comma-separated analysis passes to skip"
        type: string
        default: ""
      agrev-version:
        description: "agrev version to install"
        type: string
        default: "latest"
      fail-on-high-risk:
        description: "Fail the workflow if high risk items are found"
        type: boolean
        default: true
      post-comment:
        description: "Post results as a PR comment"
        type: boolean
        default: true

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install agrev
        run: |
          if [ "${{ inputs.agrev-version }}" = "latest" ]; then
            go install github.com/aezell/agrev/cmd/agrev@latest
          else
            go install github.com/aezell/agrev/cmd/agrev@${{ inputs.agrev-version }}
          fi

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Determine commit range
        id: range
        run: |
          if [ -n "${{ inputs.commit-range }}" ]; then
            echo "range=${{ inputs.commit-range }}" >> "$GITHUB_OUTPUT"
          else
            echo "range=${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run agrev check
        id: check
        continue-on-error: true
        run: |
          ARGS="${{ steps.range.outputs.range }}"
          ARGS="$ARGS --format ${{ inputs.format }}"
          if [ -n "${{ inputs.skip }}" ]; then
            ARGS="$ARGS --skip ${{ inputs.skip }}"
          fi
          agrev check $ARGS > agrev-report.txt 2>&1
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Post PR comment
        if: inputs.post-comment && github.event_name == 'pull_request' && inputs.format == 'markdown'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('agrev-report.txt', 'utf8');
            const body = `### agrev Analysis\n\n${report}\n\n---\n*Generated by [agrev](https://github.com/aezell/agrev)*`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes('### agrev Analysis'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Check result
        if: inputs.fail-on-high-risk
        run: |
          exit_code="${{ steps.check.outputs.exit_code }}"
          if [ "$exit_code" = "2" ]; then
            echo "::error::agrev found high-risk issues"
            exit 2
          elif [ "$exit_code" = "1" ]; then
            echo "::warning::agrev found warnings"
          fi
